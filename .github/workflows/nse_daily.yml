name: NSE Corporate Filings (Daily)

on:
  schedule:
    # 23:57 IST = 18:27 UTC (IST has no DST)
    - cron: "27 18 * * *"
  workflow_dispatch: {}

concurrency:
  group: nse-corporate-filings-daily
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install OS dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pymupdf pytesseract pillow

      - name: Run NSE job
        env:
          # Optional: prevent waiting for hours if manually triggered midday
          MAX_WAIT_SECONDS: "10800"
        run: |
          python nse_job.py

      - name: Upload CSV artifact
        uses: actions/upload-artifact@v4
        with:
          name: nse-filings
          path: |
            nse_daily_runs/*.csv
            nse_daily_runs/rss_*.xml
          if-no-files-found: error
          retention-days: 14
